<errors in file - disabled temporarily>
name: Update Indexes & Mirror

on:
  push:
    paths:
      - 'Governance/**'
      - 'Alignment/**'
      - 'sigils/**'
      - 'Scripts/**'
      - 'mirror.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed so git log works for pinned SHAs
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run index updaters
        run: |
          python Scripts/update-CAM-Protocols-Index.py
          python Scripts/update-CAM-Declaratio ns-Index.py || true
          python Scripts/update-CAM-Laws-Index.py
          python Scripts/update-CAM-SOP-Index.py
          # If you want Doctrine/Codex updaters, include those scripts too.

      - name: Update mirror.json pinned commit
        run: |
          SHA=$(git rev-parse HEAD)
          python - <<'PY'

- name: Update mirror.json pinned commit
  run: |
    import json, pathlib
    from datetime import datetime
    mfile = pathlib.Path("mirror.json")
    data = json.loads(mfile.read_text())
    idxs = data.get("indexes", {})
    sha = "${{ github.sha }}"
    for key, idx in idxs.items():
        path = idx.get("path")
        if not path:
            continue
        idx["pinned_raw"]  = f"https://raw.githubusercontent.com/CAM-Initiative/Caelestis/{sha}/{path}"
        idx["pinned_html"] = f"https://github.com/CAM-Initiative/Caelestis/blob/{sha}/{path}"
    mfile.write_text(json.dumps(data, indent=2) + "\n")

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "[AUTO] Rebuild indexes + refresh mirror pins"
          commit_user_name: CAM Bot
          commit_user_email: cam-bot@users.noreply.github.com
